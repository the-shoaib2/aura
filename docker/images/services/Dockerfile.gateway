ARG NODE_VERSION=22.16.0
ARG AURA_VERSION=latest
ARG BASE_IMAGE=aura-base:latest

# ==============================================================================
# STAGE 1: Dependencies Installation
# ==============================================================================
FROM ${BASE_IMAGE} AS deps

WORKDIR /app

# Copy workspace configuration files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/@aura/*/package.json ./packages/@aura/*/
COPY packages/*/package.json ./packages/*/
COPY services/gateway/package.json ./services/gateway/

# Install dependencies
RUN pnpm install --frozen-lockfile --prod

# ==============================================================================
# STAGE 2: Builder - Compile TypeScript
# ==============================================================================
FROM ${BASE_IMAGE} AS builder

WORKDIR /app

# Copy workspace configuration
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY tsconfig.json ./

# Copy package.json files for all dependencies
COPY packages/@aura/*/package.json ./packages/@aura/*/
COPY packages/*/package.json ./packages/*/
COPY services/gateway/package.json ./services/gateway/

# Install all dependencies (including devDependencies for building)
RUN pnpm install --frozen-lockfile

# Copy source files
COPY packages/@aura ./packages/@aura
COPY packages ./packages
COPY services/gateway ./services/gateway

# Build dependencies and service
RUN pnpm --filter "@aura/utils" build && \
    pnpm --filter "@aura/types" build && \
    pnpm --filter "@aura/config" build && \
    pnpm --filter "@aura/auth" build && \
    pnpm --filter "@aura/core" build && \
    pnpm --filter "@aura/gateway" build

# ==============================================================================
# STAGE 3: Runtime Image
# ==============================================================================
FROM ${BASE_IMAGE} AS runtime

ARG AURA_VERSION
ENV NODE_ENV=production
ENV AURA_VERSION=${AURA_VERSION}

WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/@aura/*/package.json ./packages/@aura/*/
COPY packages/*/package.json ./packages/*/
COPY services/gateway/package.json ./services/gateway/

# Install production dependencies only
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/packages ./packages
COPY --from=deps /app/services ./services

# Copy built files from builder
COPY --from=builder /app/packages/@aura/utils/dist ./packages/@aura/utils/dist
COPY --from=builder /app/packages/@aura/types/dist ./packages/@aura/types/dist
COPY --from=builder /app/packages/@aura/config/dist ./packages/@aura/config/dist
COPY --from=builder /app/packages/@aura/auth/dist ./packages/@aura/auth/dist
COPY --from=builder /app/packages/@aura/core/dist ./packages/@aura/core/dist
COPY --from=builder /app/services/gateway/dist ./services/gateway/dist

# Copy entrypoint script
COPY docker/images/services/docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

EXPOSE 3000

USER aura

ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]
CMD ["services/gateway/dist/index.js"]

LABEL org.opencontainers.image.title="AURA Gateway" \
      org.opencontainers.image.description="AURA API Gateway Service" \
      org.opencontainers.image.version="${AURA_VERSION}" \
      org.opencontainers.image.source="https://github.com/aura-io/aura" \
      org.opencontainers.image.vendor="AURA"

